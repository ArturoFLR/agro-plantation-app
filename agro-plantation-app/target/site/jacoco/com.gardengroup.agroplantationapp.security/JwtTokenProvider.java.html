<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JwtTokenProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agro-plantation-app</a> &gt; <a href="index.source.html" class="el_package">com.gardengroup.agroplantationapp.security</a> &gt; <span class="el_source">JwtTokenProvider.java</span></div><h1>JwtTokenProvider.java</h1><pre class="source lang-java linenums">package com.gardengroup.agroplantationapp.security;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import org.springframework.security.authentication.AuthenticationCredentialsNotFoundException;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Component;

import java.util.Date;

@Component
<span class="nc" id="L13">public class JwtTokenProvider {</span>

    // Método para generar un token JWT con información de autenticación
    public String generateToken(Authentication authentication) {
        // Obtener el nombre de usuario (en este caso, el email) del objeto Authentication
<span class="nc" id="L18">        String email = authentication.getName();</span>

        // Obtener la fecha actual
<span class="nc" id="L21">        Date now = new Date();</span>

        // Calcular la fecha de expiración del token sumando el tiempo de expiración configurado
<span class="nc" id="L24">        Date expirationDate = new Date(now.getTime() + ConstantSecurity.JWT_EXPIRATION_TOKEN);</span>

        // Construir el token JWT con el Builder de Jwts
<span class="nc" id="L27">        String token = Jwts.builder()</span>
<span class="nc" id="L28">                .setSubject(email) // Establecer el sujeto del token como el email del usuario</span>
<span class="nc" id="L29">                .setIssuedAt(now) // Establecer la fecha de emisión del token</span>
<span class="nc" id="L30">                .setExpiration(expirationDate) // Establecer la fecha de expiración del token</span>
<span class="nc" id="L31">                .signWith(SignatureAlgorithm.HS512, ConstantSecurity.JWT_SIGNATURE) // Firmar el token con el algoritmo y clave secreta</span>
<span class="nc" id="L32">                .compact(); // Compactar el token en una cadena</span>

        // Devolver el token generado
<span class="nc" id="L35">        return token;</span>
    }

    // Método para obtener el nombre de usuario (email) a partir de un token JWT
    public String getJwtUser(String token) {
        // Utilizar el parser de Jwts para obtener los claims (reclamaciones) del token
<span class="nc" id="L41">        Claims claims = Jwts.parser()</span>
<span class="nc" id="L42">                .setSigningKey(ConstantSecurity.JWT_SIGNATURE) // Establecer la clave secreta para validar la firma</span>
<span class="nc" id="L43">                .parseClaimsJws(token) // Realizar el parsing del token</span>
<span class="nc" id="L44">                .getBody(); // Obtener el cuerpo del token, que contiene los claims</span>

        // Devolver el nombre de usuario (email) obtenido de los claims
<span class="nc" id="L47">        return claims.getSubject();</span>
    }

    // Método para validar un token JWT
    public Boolean validateToken(String token) {
        try {
            // Intentar realizar el parsing del token, si tiene una firma válida
<span class="nc" id="L54">            Jwts.parser().setSigningKey(ConstantSecurity.JWT_SIGNATURE).parseClaimsJws(token);</span>

            // Si el parsing es exitoso, el token es válido
<span class="nc" id="L57">            return true;</span>
<span class="nc" id="L58">        } catch (Exception e) {</span>
            // Agregar logs para ver más detalles sobre la excepción
<span class="nc" id="L60">            System.out.println(&quot;Error al validar el token: &quot; + e.getMessage());</span>
            // Si ocurre una excepción durante el parsing, el token no es válido
<span class="nc" id="L62">            throw new AuthenticationCredentialsNotFoundException(&quot;JWT ha expirado o está incorrecto&quot;);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>